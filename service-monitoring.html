<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Service Monitoring</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 24px; }
    .status-badge { text-transform: uppercase; font-weight: 600; }
    .result { white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
  </style>
</head>
<body>
  <div class="d-flex align-items-center mb-3">
    <h1 class="h4 mb-0">Service Monitoring</h1>
    <button id="btn-refresh" class="btn btn-sm btn-outline-primary ms-3">Refresh</button>
    <span id="last-upd" class="ms-auto text-secondary small"></span>
  </div>

  <div class="table-responsive">
    <table class="table table-sm align-middle" id="tbl">
      <thead class="table-light">
        <tr>
          <th>Timestamp (UTC)</th>
          <th>Status</th>
          <th>Job</th>
          <th>Command</th>
          <th>Hasil</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
const DATA_URL = '/service-monitoring/monitor_latest.json'; 
// Sesuaikan: pastikan file JSON ini terpublikasi di path tersebut
// (mis. disalin dari logs/monitor_latest.json oleh cron/CI atau KV sync)

function badge(status) {
  let cls = 'bg-secondary';
  if (status === 'success') cls = 'bg-success';
  else if (status === 'error') cls = 'bg-danger';
  else if (status === 'start') cls = 'bg-warning text-dark';
  return `<span class="badge status-badge ${cls}">${status}</span>`;
}

async function load() {
  const tbody = document.querySelector('#tbl tbody');
  tbody.innerHTML = `<tr><td colspan="5" class="text-secondary">Memuat...</td></tr>`;
  try {
    const res = await fetch(DATA_URL, { cache: 'no-store' });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const latest = await res.json();
    // latest: { jobName: {ts, status, command, result, exit_code, ...}, ... }
    const rows = Object.values(latest)
      .sort((a,b) => (a.ts < b.ts ? 1 : -1))
      .map(item => `
        <tr>
          <td class="text-nowrap">${item.ts ?? ''}</td>
          <td>${badge(item.status ?? '')}</td>
          <td class="text-nowrap">${item.job ?? ''}</td>
          <td><code>${(item.command ?? '').replaceAll('<','&lt;')}</code></td>
          <td class="result">${(item.result ?? '').replaceAll('<','&lt;')}</td>
        </tr>
      `).join('');
    tbody.innerHTML = rows || `<tr><td colspan="5" class="text-secondary">Belum ada data.</td></tr>`;
    document.getElementById('last-upd').textContent = 'Updated: ' + new Date().toLocaleString();
  } catch (e) {
    tbody.innerHTML = `<tr><td colspan="5" class="text-danger">Gagal memuat data: ${e.message}</td></tr>`;
  }
}

document.getElementById('btn-refresh').addEventListener('click', load);

// Auto-refresh tiap 30 detik
load();
setInterval(load, 30000);
</script>
</body>
</html>
